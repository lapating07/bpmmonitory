<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Heart Rate & Blood Oxygen Dashboard</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { background: #f5f7fa; font-family: Arial, sans-serif; text-align: center; padding: 30px; }
h1, h2 { color: #333; }
.card { background: #fff; border-radius: 12px; padding: 20px; margin: 20px auto; max-width: 650px; box-shadow: 0 5px 15px rgba(0,0,0,.1); }
.value { font-size: 2rem; font-weight: bold; }
.status { font-weight: bold; margin-left: 8px; }
.low { color: #e74c3c; }
.normal { color: #27ae60; }
.high { color: #f39c12; }

.chart-container { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,.1); max-width: 1100px; margin: auto; }

table { width: 95%; max-width: 1100px; margin: 30px auto; border-collapse: collapse; background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,.1); }
th, td { padding: 12px; border-bottom: 1px solid #eee; }
th { background: #f0f0f0; }
tr:hover { background: #f9f9f9; }
</style>
</head>
<body>

<h1>ðŸ“¡ Heart Rate & Blood Oxygen Saturation Dashboard</h1>

<!-- LIVE CARD -->
<div class="card">
  <h2>Live Result</h2>
  <div>
    BPM: <span class="value" id="liveBPM">--</span>
    <span id="bpmStatus" class="status"></span>
  </div>
  <div>
    SpOâ‚‚: <span class="value" id="liveSpO2">--</span>
    <span id="spo2Status" class="status"></span>
  </div>
</div>

<!-- GRAPH -->
<h2>ðŸ“ˆ Graph (Latest 10 Records)</h2>
<div class="chart-container">
  <canvas id="liveChart"></canvas>
</div>

<!-- TABLE -->
<h2>ðŸ“„ Record Table (Latest 10)</h2>
<table id="historyTable">
  <thead>
    <tr>
      <th>Date</th>
      <th>Time</th>
      <th>BPM</th>
      <th>BPM Status</th>
      <th>SpOâ‚‚</th>
      <th>SpOâ‚‚ Status</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCOzEqHCKqOZG9pbROs1JJku19yN0S9zEI",
  authDomain: "dpmspo2.firebaseapp.com",
  databaseURL: "https://dpmspo2-default-rtdb.firebaseio.com",
  projectId: "dpmspo2",
  storageBucket: "dpmspo2.firebasestorage.app",
  messagingSenderId: "86512121446",
  appId: "1:86512121446:web:0bad04d8fa786db26f9fa7"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const liveBPM = document.getElementById("liveBPM");
const liveSpO2 = document.getElementById("liveSpO2");
const bpmStatusEl = document.getElementById("bpmStatus");
const spo2StatusEl = document.getElementById("spo2Status");
const tableBody = document.querySelector("#historyTable tbody");

/* ===== STATUS FUNCTIONS ===== */
function bpmStatus(bpm) {
  if (bpm < 60) return ["Low", "low"];
  if (bpm <= 100) return ["Normal", "normal"];
  return ["High", "high"];
}

function spo2Status(spo2) {
  if (spo2 < 95) return ["Low", "low"];
  if (spo2 <= 100) return ["Normal", "normal"];
  return ["High", "high"];
}

/* ===== CHART ===== */
const ctx = document.getElementById("liveChart").getContext("2d");
const liveChart = new Chart(ctx, {
  type: "line",
  data: {
    labels: [],
    datasets: [
      { label: "BPM", data: [], borderWidth: 2 },
      { label: "SpOâ‚‚", data: [], borderWidth: 2 }
    ]
  }
});

/* ===== LAST RECORD ===== */
let lastRecord = { BPM: null, SpO2: null };

/* ===== TABLE ===== */
function addRow(r) {
  const row = `
  <tr>
    <td>${r.date}</td>
    <td>${r.time}</td>
    <td>${r.BPM}</td>
    <td class="${r.bpmClass}">${r.bpmStatus}</td>
    <td>${r.SpO2}</td>
    <td class="${r.spo2Class}">${r.spo2Status}</td>
  </tr>`;
  tableBody.innerHTML = row + tableBody.innerHTML;
  while (tableBody.rows.length > 10) tableBody.deleteRow(10);
}

/* ===== LIVE LISTENER ===== */
db.ref("Live").on("value", snapshot => {
  const d = snapshot.val();
  if (!d || d.BPM == 100 && d.SpO2 == 100) return;

  const now = new Date();
  const [bpmText, bpmClass] = bpmStatus(d.BPM);
  const [spo2Text, spo2Class] = spo2Status(d.SpO2);

  liveBPM.innerText = d.BPM;
  liveSpO2.innerText = d.SpO2;

  bpmStatusEl.innerText = `(${bpmText})`;
  bpmStatusEl.className = `status ${bpmClass}`;

  spo2StatusEl.innerText = `(${spo2Text})`;
  spo2StatusEl.className = `status ${spo2Class}`;

  if (d.BPM !== lastRecord.BPM || d.SpO2 !== lastRecord.SpO2) {
    lastRecord = { BPM: d.BPM, SpO2: d.SpO2 };

    liveChart.data.labels.push(now.toLocaleTimeString());
    liveChart.data.datasets[0].data.push(d.BPM);
    liveChart.data.datasets[1].data.push(d.SpO2);
    if (liveChart.data.labels.length > 10) {
      liveChart.data.labels.shift();
      liveChart.data.datasets[0].data.shift();
      liveChart.data.datasets[1].data.shift();
    }
    liveChart.update();

    const record = {
      BPM: d.BPM,
      SpO2: d.SpO2,
      bpmStatus: bpmText,
      spo2Status: spo2Text,
      bpmClass,
      spo2Class,
      date: now.toLocaleDateString("en-CA"),
      time: now.toLocaleTimeString()
    };

    db.ref("Records").push(record);
    addRow(record);
  }
});
</script>

</body>
</html>
