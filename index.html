<!DOCTYPE html>
<html>
<head>
  <title>Live Health Dashboard</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <!-- ChartJS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background: #f5f5f5;
      color: #333;
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 10px;
    }

    h2 { color: #ff4081; }

    #chartContainer {
      width: 100%;
      max-width: 100%;
      height: 180px;
      margin: auto;
    }

    canvas {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 10px;
    }

    #historyBtn {
      margin: 10px 0;
      padding: 8px 20px;
      font-size: 14px;
      background: #ff4081;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      display: none;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      font-size: 14px;
    }

    th {
      background: #ff4081;
      color: white;
    }

    #bpmVal, #spo2Val {
      font-size: 20px;
      font-weight: bold;
    }
  </style>
</head>

<body>

<h2>❤️ Live Heart Monitor</h2>

<div>
  BPM: <span id="bpmVal">--</span> |
  SpO₂: <span id="spo2Val">--</span>
</div>

<div id="chartContainer">
  <canvas id="liveChart"></canvas>
</div>

<button id="historyBtn">Show History</button>

<table id="historyTable">
  <tr>
    <th>Time</th>
    <th>BPM</th>
    <th>SpO₂</th>
  </tr>
</table>

<script>
  // ===== Firebase Config =====
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    databaseURL: "YOUR_DATABASE_URL"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const bpmVal = document.getElementById("bpmVal");
  const spo2Val = document.getElementById("spo2Val");
  const historyBtn = document.getElementById("historyBtn");
  const historyTable = document.getElementById("historyTable");

  // ===== Chart Setup (waveform style) =====
  const ctx = document.getElementById("liveChart").getContext("2d");

  const chartData = {
    labels: Array(100).fill(""),
    datasets: [{
      label: "Pulse Wave",
      data: Array(100).fill(0),
      borderColor: "#ff0000",
      borderWidth: 2,
      tension: 0,     // NO smoothing = sharp spikes
      pointRadius: 0
    }]
  };

  const liveChart = new Chart(ctx, {
    type: "line",
    data: chartData,
    options: {
      animation: false,
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { display: false },
        y: { min: 0, max: 100000 }  // matches raw sensor range
      },
      plugins: {
        legend: { display: false }
      }
    }
  });

  // ===== Live Data from Firebase =====
  db.ref("LiveWave").on("value", snap => {
    const raw = snap.val();
    if (!raw) return;

    chartData.datasets[0].data.push(raw);
    chartData.datasets[0].data.shift();
    liveChart.update();
  });

  db.ref("Live").on("value", snap => {
    const d = snap.val();
    if (!d) return;
    bpmVal.innerText = d.BPM;
    spo2Val.innerText = d.SpO2;
  });

  // ===== History Table =====
  historyBtn.addEventListener("click", () => {
    if (historyTable.style.display === "none") {
      historyTable.style.display = "table";
      while (historyTable.rows.length > 1) historyTable.deleteRow(1);

      db.ref("History").limitToLast(50).once("value", snapshot => {
        snapshot.forEach(child => {
          const row = historyTable.insertRow();
          const data = child.val();
          const time = new Date(data.time).toLocaleString();
          row.insertCell(0).innerText = time;
          row.insertCell(1).innerText = data.bpm;
          row.insertCell(2).innerText = data.spo2;
        });
      });
    } else {
      historyTable.style.display = "none";
    }
  });
</script>

</body>
</html>
