<!DOCTYPE html>
<html>
<head>
  <title>Live Health Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: #f5f5f5;
      color: #333;
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 20px;
    }

    h2 {
      color: #ff4081;
    }

    #chartContainer {
      width: 90%;
      max-width: 800px;
      margin: auto;
    }

    canvas {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 10px;
    }

    #historyBtn {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
      background: #ff4081;
      color: #fff;
      border: none;
      border-radius: 5px;
    }

    #historyTable {
      margin: 20px auto;
      width: 90%;
      max-width: 800px;
      border-collapse: collapse;
      display: none;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
    }

    #historyTable th, #historyTable td {
      border: 1px solid #ccc;
      padding: 8px;
    }

    #historyTable th {
      background: #ff4081;
      color: #fff;
    }

    #bpmVal, #spo2Val {
      font-size: 2em;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h2>ðŸ”´ Live Heart Monitor</h2>

<p>BPM: <span id="bpmVal">--</span> | SpOâ‚‚: <span id="spo2Val">--</span></p>

<div id="chartContainer">
  <canvas id="liveChart" height="200"></canvas>
</div>

<button id="historyBtn">Show History Table</button>

<table id="historyTable">
  <tr>
    <th>Time</th>
    <th>BPM</th>
    <th>SpOâ‚‚</th>
  </tr>
</table>

<script>
  // ===== Firebase Config =====
  const firebaseConfig = {
    apiKey: "AIzaSyB8yZZHmjx4ExnkeV_V5iieSK5tSdY_Uqo",
    databaseURL: "https://bpmhealth-813a8-default-rtdb.firebaseio.com/"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const bpmVal = document.getElementById("bpmVal");
  const spo2Val = document.getElementById("spo2Val");
  const historyBtn = document.getElementById("historyBtn");
  const historyTable = document.getElementById("historyTable");

  // ===== Chart Setup =====
  const ctx = document.getElementById("liveChart").getContext("2d");
  const chartData = {
    labels: [],
    datasets: [
      { label: "BPM", data: [], borderColor: "#ff4081", fill: false, tension: 0.3 },
      { label: "SpOâ‚‚", data: [], borderColor: "#00bcd4", fill: false, tension: 0.3 }
    ]
  };
  const liveChart = new Chart(ctx, {
    type: "line",
    data: chartData,
    options: {
      responsive: true,
      animation: false,
      scales: {
        x: { display: false }, // hide x-axis labels for live line
        y: { min: 0, max: 150 }
      },
      plugins: { legend: { position: 'top' } }
    }
  });

  // ===== Live Reading =====
  db.ref("Live").on("value", snapshot => {
    const data = snapshot.val();
    if (!data) return;

    const bpm = data.BPM;
    const spo2 = data.SpO2;

    bpmVal.innerText = bpm;
    spo2Val.innerText = spo2;

    const now = new Date().toLocaleTimeString();
    chartData.labels.push(now);
    chartData.datasets[0].data.push(bpm);
    chartData.datasets[1].data.push(spo2);

    if (chartData.labels.length > 30) {
      chartData.labels.shift();
      chartData.datasets[0].data.shift();
      chartData.datasets[1].data.shift();
    }

    liveChart.update();
  });

  // ===== Show History Table =====
  historyBtn.addEventListener("click", () => {
    historyTable.style.display = historyTable.style.display === "none" ? "table" : "none";
    if (historyTable.style.display === "table") {
      // Clear previous rows except header
      while (historyTable.rows.length > 1) historyTable.deleteRow(1);

      db.ref("History").orderByKey().limitToLast(50).once("value", snap => {
        snap.forEach(childSnap => {
          const d = childSnap.val();
          const row = historyTable.insertRow();
          row.insertCell(0).innerText = new Date(d.time).toLocaleString();
          row.insertCell(1).innerText = d.bpm;
          row.insertCell(2).innerText = d.spo2;
        });
      });
    }
  });
</script>

</body>
</html>
