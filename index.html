#include <WiFi.h>
#include <Wire.h>
#include "MAX30105.h"
#include "spo2_algorithm.h"
#include <Firebase_ESP_Client.h>
#include <addons/TokenHelper.h>

#define WIFI_SSID     "Home_WiFi.2ZJR"
#define WIFI_PASSWORD "admin12345"

#define API_KEY      "AIzaSyB8yZZHmjx4ExnkeV_V5iieSK5tSdY_Uqo"
#define DATABASE_URL "https://bpmhealth-813a8-default-rtdb.firebaseio.com/"

FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;

MAX30105 sensor;

uint32_t irBuffer[100], redBuffer[100];

int32_t spo2, heartRate;
int8_t validSPO2, validHeartRate;

void connectWiFi() {
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  Serial.print("Connecting");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500); Serial.print(".");
  }
  Serial.println("\n✅ WiFi Connected");
}

void setup() {
  Serial.begin(115200);
  connectWiFi();

  auth.user.email = "";
  auth.user.password = "";
  config.api_key = API_KEY;
  config.database_url = DATABASE_URL;
  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);

  Wire.begin(21, 22);
  sensor.begin(Wire);
  sensor.setup();
  sensor.setPulseAmplitudeRed(0x7F);
  sensor.setPulseAmplitudeIR(0x7F);

  Serial.println("✅ System Ready");
}

void loop() {
  long ir = sensor.getIR();
  if (ir < 30000) {
    delay(400);
    return;
  }

  for (int i=0; i<100; i++) {
    while(!sensor.available()) sensor.check();
    redBuffer[i]=sensor.getRed();
    irBuffer[i]=sensor.getIR();
    sensor.nextSample();
  }

  maxim_heart_rate_and_oxygen_saturation(irBuffer, 100, redBuffer, &spo2, &validSPO2, &heartRate, &validHeartRate);

  if (validSPO2 && validHeartRate) {

    unsigned long stamp = millis();
    String livePath = "/LiveData/" + String(stamp);
    String historyPath = "/History/" + String(stamp);

    FirebaseJson json;
    json.set("bpm", heartRate);
    json.set("spo2", spo2);
    json.set("timestamp", stamp);

    Firebase.RTDB.setJSON(&fbdo, livePath, &json);
    Firebase.RTDB.setJSON(&fbdo, historyPath, &json);

    Serial.print("✅ BPM: ");Serial.print(heartRate);
    Serial.print(" | SpO2: ");Serial.println(spo2);
  }

  delay(1000);
}
